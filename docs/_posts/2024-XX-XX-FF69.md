---
layout: post
number: "XX"
title: "Forensic Friday 69: "
desc: ""
date: 20XX-XX-XX 00:00:00 +0100
published: false 
permalink: "/ffXX"
---

<img class="speakerimg" src="./unrelated-media/pfp-david.png" width="100%"/> 
<div class="speaker">
    <div class="title">ðŸ“£David</div>
</div>

# Hey Readers!

Welcome to Forensic Friday 69! It has been a long while, but we are back, and a lot has happened! We took a break from business as usual due to a lack of development from life stuff, but we still managed to do work anyways so wasn't totally necessary. Anyways, there is a lot to cover, and we don't want this blog to get ridicously long, so lets just jump straight into what we have in store: Better pipes, better structural integrity, and probably most significantly underground floors! All this comes under an effort to polish up construction side of things, which is arguably the most important aspect of the game. Well... let's get into it!

<img class="speakerimg" src="./unrelated-media/pfp-lydia.png" width="100%"/> 
<div class="speaker">
    <div class="title">ðŸ“£ Dillan</div>
</div>

# Kicking a Dead Pipe

If you're a regular reader of our blogs, then you'll know of the hardships and battles we've had while trying to implement fluid pipes. A problem that persisted for way too many years of development for my liking, we finally reached a point where we had a solution. You can take a look at [Forensic Friday 23](https://plasmarcstudios.co.uk//containcorp-blog/ff23#whats-left) and [Forensic Friday 24](https://plasmarcstudios.co.uk//containcorp-blog/ff24#better-pipes) for more info, which goes into more depth about our fluid system's inner workings. Fluid was still flowing slowly (the videos in the FF23 and 24 blogs were at 10x speed), but the introduction of pumps kind of made this a low priority for us. It worked, and that was better than any other solution we'd tried before.

Fast forward roughly 450 days, and I was lying in bed, staring at the void of my bedroom ceiling. Our cellular automata was an array of fluid cells - each one containing a fluid type or empty. A random cell from the list was chosen, and transferred to a random adjacent fluid holder every iteration of the algorithm. This randomness was what made our fluid system work, where previous attempts had failed - if something was mainly empty, then you're more likely to choose an empty cell to transfer (so fluid transfers from high volume areas to low volume areas). The transfer fluid in and out cells described in FF24 had since been removed, and since we were now relying on probability alone for fluid to decide where to go, why were we modelling fluid holders with an array? The simple answer was "if it ain't broke, don't fix it". But, in a very convoluted step, due to a number of refactors inbetween, we were essentially picking a random number by choosing a random cell from an array. The problem with this? Just a lot of unnecessary array operations, which are memory and performance intensive, while providing no benefits compared to alternatives.

I've taken a step back from coding in recent months, but had a couple weeks holiday from work, which freed up some time to let my intrusive shower thoughts come to fruition. Moving the fluid system from using an array to a data centric approach, we now have a much more performance friendly solution with a couple of key benefits. Every fluid holder now has a set of key-pair values - the fluid type, and the amount of that fluid type present. Since we're no longer modelling cellular automata with arrays, we're no longer constrained to 1 cell containing 1 type of fluid (for reference, a pipe contained about 100 cells).

In gameplay terms this means that, while previously the smallest amount of fluid we could transfer was 1 cell, we can now transfer any specific number we want. This means we're no longer constrained to fluids being multiples of 5 litres (the minimum cell size). This also means in a single fluid system iteration, multiple types of fluids can be transferred between fluid holders in smaller quantities. E.g. if we wanted to transfer 15 litres of fluid from 1 pipe to another, previously we would have had to transfer 3 cells, which means a maximum of 3 different fluid types. Now, transferring 15 litres is a lot more intuitive - we can move fractional amounts of each fluid type in the same tick. So if a fluid holder contains 7 different fluids, then we can take the proportional amount of each of the 7 fluid types in the same iteration.

The result is that we now have a fluid system which is:

1. more memory efficient
 - no massive arrays holding potentially 1000s of fluid cells
2. faster computationally
 - to calculate amounts we don't have to loop through that massive array of cells, just add amounts for each unique fluid type
 - less iterations needed per game tick (from 80 to 20)
3. more scalable - we can add new properties to fluids that we couldn't previously, since before everything was limited to being a cell
 - different viscosities of fluids, allowing different fluids to travel at different speeds
 - temperatures for fluids (WIP) which will pave the way for boilers etc.
 - from a dev point of view, new fluids can be added using Unity's scriptable objects
4. more intuitive
 - no constraints on fluid cell size - you can transfer any amount, not just a multiple of 5!
 - quicker flow rate through pipes

Along with these changes, there's been some minor changes to all existing fluid holders to work with this new system, which has improved (at least in my opinion) how they work in game. Some of the most noticeable ones are:
* Pumps now pull from the fluid holder going into them, as well as pushing outwards, making them transfer fluid a lot more effectively.
* Showers now take each unique fluid type and their corresponding amounts for calculating the hygiene score that should be given to an NPC after showering. Previously, a shower output 6 fluid cells every game tick, that we then used to calculate how clean the NPC was. Therefore your shower could've had sewage in it, but by random chance you got 6 water cells, giving your NPC a 100% satisfaction score. Now proportional amounts of each fluid present are used.
* The water purification plant now separates fluids in the same proportion as they come into the plant. I.e. if you have 200L of sewage and 100L of water, then the plant will always output both sewage and water in separate outputs, in a ratio of 2:1, e.g. like 10L sewage and 5L water every tick. Previously, the water purification plant took from a number of random fluid cells, so you weren't guarenteed to have both water output and waste output consistently.

I know better than to call this a done deal - there's always something else, but I'm extremely happy with how this has worked out so far, and it's definitely a major improvement on top of what we had already!

# Fluids in a new dimension

This all nicely ties into why I was staring into my bedroom ceiling thinking about pipes (no, I don't just do that normally, I swear). In recent weeks, we've been polishing some aspects to do with multiple floors - more on that later on in this blog. Fluid pipes had been such a pain to implement, and by the time I implemented the current system, I was so desparate to move on that I never actually got around to making them connect between floors. Fast forward the 450ish days and that was the singular goal for my 2 weeks off - make pipes connect between floors. This shouldn't have taken that long, but sent me down the rabbit hole of a basic reworking of the fluid system as I just described in the last section.

However, enough of that - what's important is that pipes now connect between floors. Putting a pipe on a floor above another pipe automatically connects them together. However, this is where another change to how we simulate fluid flow was required. If a pipe is above another pipe, you would expect all the fluid inside to flow to the bottom one due to gravity. Therefore, our whole rule about "choosing a random neighbouring fluid holder to transfer to" needed to be reworked as well. I trialled a system whereby there is a greater probability that fluids will flow downwards, than sideways or upwards. This worked great but kind of lead to a bit of a headache when it came to flowing upwards. 

Over enough iterations, the probability dictates exactly where the fluid will go, so giving a greater probability to travel downwards meant that fluids ALWAYS travelled downwards. Which is fine, except when we had a pump on the bottom floor, and wanted to pump upwards with pressure. In this case, a tiny amount of fluid would go upwards, and then a larger amount would immediately try to flow back down to where it came from, meaning the fluids were kind of stuck in limbo on the ground floor. Messing around with the order of execution between entities, so that pumps always filled up the pipes before the pipes on the floor above transferred their contents back down again proved useless, since this just offset the problem by a single floor - now we had an issue transferring fluids between multiple floors without using a pump on every floor. A very simple and effective workaround ended up being that we bump up the flow upwards probability when the fluid in the pipe is above a certain threshold. I chose 90% as a threshold, but I'm sure we'll play around with this for larger fluid holders. If pipes hold 500 litres, then when the pipes reaches 450 litres, fluids in that pipe can start to flow upwards. This will still flow back down again, but since a larger quantity of fluid is now being shifted upwards in a single iteration, this gives the pumps some extra game ticks to fill up the pipe on the lower floor. 

The result is a fluid system that is multifloor, and appears to be effected by gravity, while also being able to be pumped to floors above without having to use a detailed pressure metric (which we've unsuccessfully attempted to use in a lot of failed versions of the fluid system). With a more efficient way to get the total fluid in a fluid holder (we have a memoized value), this has also opened the path for pipes using the structural integrity system - which David will talk more about next. Interestingly, fluid in a pipe increases the weight dynamically, which could cause some really cool realtime "physics" taking place. 

<img class="speakerimg" src="./unrelated-media/pfp-david.png" width="100%"/> 
<div class="speaker">
    <div class="title">ðŸ“£David</div>
</div>
# Buildings collapse with Style

> column weight is now properly accounted for in structural integrity algorithm
> (i.e. you might actually need to build foundations for your structures now!)
> made structural integrity algorithm more realistic (stress now travels down to supports)
> structural integrity now uses cellular automata to calculate stress in real time
> All tiles input their weight into yload (cos gravity).

(First Rule) Any tile with no tile beneath it transfers yload into the tile above. If there is no tile above, then it is marked for death.

(Second Rule) Tiles weigh down on tiles below them, transferring yload.

(Third Rule) Tiles distribute yload to horizontal neighbors as xload, and distribute yload to vertical neighbors below as yload.

(Fourth Rule) Tiles transfer load to the ground, where it gets divided by the ground strength.

(Last Rule) Any tile that is overstressed on X or Y load dies.

# Dwarfcorp

> added support for underground floors (negative floors)
> Underground earth composition now generates
> Added new excavation order
> Builders can now excavate ground when ordered
> Tiles can now show arbitrary progress bars
> Npcs can now fall down holes
> Npcs recieve exponential injuries based on fall distance
> multithreaded underground floor loading for increased performance when loading new floors
> only exposed underground tiles are now shown
> negative floors are now only created when tiles are exposed
> npcs will no longer excavate tiles they stand on
> npcs path to avoid holes

# When all ways are blocked, walk up

> NPCs now properly path between floors
> NPC path routes now factor in floor height in route simplication algorithm

<img class="speakerimg" src="./unrelated-media/pfp-lydia.png" width="100%"/> 
<div class="speaker">
    <div class="title">Dillan</div>
</div>
# Containcorp through a Logistical lense
> Added logistic view
> added high, medium and low voltage cables
> added small pipes
> medium and low voltage cables, and small pipes can pass through walls
> pipes and any other tile entities can now display icon for multi-floor connections
> revamped high to medium transformer sprite
> pipe fluid bars hide between layers properly
> wire pipes and wire cables can now be marked for deconstruction when in logistics mode
> pipe fluid bars now only show in logistics mode

<img class="speakerimg" src="./unrelated-media/pfp-david.png" width="100%"/> 
<div class="speaker">
    <div class="title">ðŸ“£David</div>
</div>
# Small features
> npcs can be swapped in hierarchy tree
> revamped transformer tile sprites

Image example:

<div style="display:flex">
    <div style="flex:1;padding-right:10px;">
        <img src="./forensic-friday-media/ff43/comms.png" width="100%"/>
    </div>
</div>

Multiple image example:

<div style="display:flex">
    <div style="flex:1;padding-right:10px;">
        <img src="./forensic-friday-media/ff43/wallold.png" width="100%"/>
    </div>
     <div style="flex:1;padding-right:10px;">
        <img src="./forensic-friday-media/ff43/wallnew.png" width="100%"/>
    </div>
</div>

dropdown

<details>
<summary>2) Locate CoreMod in Mod Folder </summary>
<div style="display:flex">
     <div style="flex:1;padding-right:10px;">
          <img src="./forensic-friday-media/ff50/2.png" width="100%"/>
     </div>
</div>
</details>

Link example:
[name](link)

[Forensic Friday 54](https://plasmarcstudios.co.uk//containcorp-blog/ff54){:target="\_blank"}

<video width="320" height="240" controls>
<source src="./forensic-friday-media/ff14/hauling_1.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

<img class="speakerimg" src="./unrelated-media/pfp-lydia.png" width="100%"/> 
<div class="speaker">
    <div class="title">Dillan</div>
</div>

# Case Closed

OUTRO

**Case Closed.**\
**The Team**\
**Plasmarc Studios**
